Lurker
=============

Overview
-------------
Lurker disguises TCP listen port and collecting payload data that attacker sent.


Install
-------------

### Requires

- libpcap
- libev
- libfluent (install from [github]
- libswarm (install from [github](https://github.com/m-mizutani/libfluent))

### Setup

    % git clone https://github.com/m-mizutani/lurker.git
    % cd lurker
    % cmake .
    % make
    % sudo make install

If you need to specify libfluent prefix, you can use `-DWITH_FLUENT` option.

    % git clone https://github.com/m-mizutani/lurker.git
    % cd lurker
    % cmake -DWITH_FLUENT=$HOME/local .
    % make
    % sudo make install
    
Usage
-------------

Monitor eth0 and reply for a packet to 10.0.0.200 and TCP port 3128. Output log data to `lurker.log` as msgpack format.

    % sudo lurker -i eth0 10.0.0.200:3128 -o lurker.log

Monitor eth0 and reply for all packet to 10.0.0.200 (any TCP port). Output to fluentd for localhost, port 24224.

    % sudo lurker -i eth0 "10.0.0.200:*" -f localhost:24224

The output message for fluentd contains binary data. If you want to save it DB that doesn't support binary format such as MongoDB, you can add `-H` option to convert HEX string from binary data.

    % sudo lurker -i eth0 "10.0.0.200:*" -f localhost:24224 -H

Dry run mode, read packet from `test.pcap`. Just extract TCP first data segment.

    % lurker -r test.pcap

Output sample
-------------

Basically output format is according to fluebtd, `[tag, timestamp, message]`.

### ARP request log

If Lurker replied ARP who-has request, `replied` is `true`.

```json
[
  "lurker.arp_req",
  14121633xx,
  {
    "dst_addr" : "172.30.1.111",
    "dst_hw" : "00:00:00:00:00:00",
    "replied" : true,
    "src_addr" : "172.30.1.1",
    "src_hw" : "06:35:8A:6D:7D:37"
  }
]
```


### TCP SYN packet log

```json
[
  "lurker.tcp_syn",
  14121633xx,
  {
    "dst_addr" : "172.30.1.111",
    "dst_port" : 22,
	"src_addr" : "218.7.37.xx",
	"src_port" : 612
  }
]
```

### TCP Data segment log

`hash` is generated by source/destination IP address, port number and protocol. `data` field may contain binary (a.k.a. not ascii) data.

```json
[
  "lurker.tcp_data",
  14121633xx,
  {
    "dst_addr" : "172.30.1.36",
    "dst_port" : 80,
	"hash" : "65CB4ECBEF1A865D",
	"data" : "GET...",	
	"src_addr" : "182.118.53.74",
	"src_port" : 39096
  }
]
```

If option `-H` is enabled, format is below.

```json
[
  "lurker.tcp_data",
  14121633xx,
  {
    "dst_addr" : "172.30.1.36",
    "dst_port" : 80,
	"hash" : "65CB4ECBEF1A865D",
	"hex_data" : "474554..",
	"src_addr" : "182.118.53.74",
	"src_port" : 39096
  }
]
```

License
--------------
BSD 2-Clause license.

Author
--------------
- Masayoshi Mizutani <mizutani@sfc.wide.ad.jp>
